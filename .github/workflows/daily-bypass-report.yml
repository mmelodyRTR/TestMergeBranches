name: "Manual Bypass Report"

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Search for Bypass Commits from the last 24 hours
      - name: Find Bypass Commits
        id: search
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Calculate timestamp for 24 hours ago
          DATE_SINCE=$(date -d "24 hours ago" +%Y-%m-%dT%H:%M:%S)
          echo "Searching for commits since: $DATE_SINCE"

          # Search for our unique signature "BYPASS MERGE"
          gh search commits "BYPASS MERGE" \
            --repo ${{ github.repository }} \
            --committer-date ">$DATE_SINCE" \
            --json commit,sha,author \
            > raw_commits.json
          
          echo "Found $(jq length raw_commits.json) bypass events."

      # 2. Parse Data & Generate Report (CSV + Markdown)
      - name: Process Report
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Generate Output
        run: |
          python3 -c "
          import json
          import csv
          import re
          import os

          # Load raw data
          try:
              with open('raw_commits.json', 'r') as f:
                  commits = json.load(f)
          except FileNotFoundError:
              commits = []

          # Define Headers
          headers = ['Date', 'Actor', 'Ticket', 'Category', 'Reason', 'Commit SHA']
          
          # Regex patterns (matching your commit message format)
          patterns = {
              'Ticket': re.compile(r'Ticket:\s*(.*)', re.IGNORECASE),
              'Category': re.compile(r'Category:\s*(.*)', re.IGNORECASE),
              'Reason': re.compile(r'Reason:\s*(.*)', re.IGNORECASE)
          }

          rows = []

          # Parse Commits
          for c in commits:
              msg = c['commit']['message']
              user = c['commit']['author']['name']
              date = c['commit']['author']['date']
              sha = c['sha'][:7] # Short SHA
              
              # Extract details
              data = {'Ticket': 'N/A', 'Category': 'N/A', 'Reason': 'N/A'}
              for key, pattern in patterns.items():
                  match = pattern.search(msg)
                  if match:
                      data[key] = match.group(1).strip()

              rows.append([date, user, data['Ticket'], data['Category'], data['Reason'], sha])

          # A. Write to CSV (File)
          with open('bypass_report.csv', 'w', newline='') as csvfile:
              writer = csv.writer(csvfile)
              writer.writerow(headers)
              writer.writerows(rows)

          # B. Write to GitHub Job Summary (Markdown)
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as summary:
              summary.write('## ðŸš¨ Daily Bypass Report\n')
              summary.write(f'**Total Bypasses (Last 24h):** {len(rows)}\n\n')
              
              if len(rows) > 0:
                  # Create Markdown Table Header
                  summary.write('| ' + ' | '.join(headers) + ' |\n')
                  summary.write('| ' + ' | '.join(['---'] * len(headers)) + ' |\n')
                  
                  # Create Markdown Table Rows
                  for row in rows:
                      summary.write('| ' + ' | '.join(row) + ' |\n')
              else:
                  summary.write('âœ… No bypasses found in the last 24 hours.\n')
          "

      # 3. (Optional) Still upload the CSV as a file for download
      - name: Upload CSV Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bypass-report-csv
          path: bypass_report.csv
