name: "Release Orchestrator"

on:
  issue_comment:
    types: [created]

permissions:
  contents: read

jobs:
  process-change:
    name: Process Non-Standard Change
    runs-on: ubuntu-latest
    
    # TRIGGER: Check if the comment starts with the base command
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/release-orchestrator')

    steps:
      - name: Generate Bot Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.BYPASS_APP_ID }}
          # UPDATED: Using the specific secret name requested
          private-key: ${{ secrets.BYPASS_APP_CLIENT_KEY }}

      - name: Process Command
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            // --- CONFIGURATION ---
            const ROOT_COMMAND = '/release-orchestrator';
            const SUB_COMMAND = 'non-standard-change';
            const FULL_COMMAND = `${ROOT_COMMAND} ${SUB_COMMAND}`;
            
            // UPDATED: New Enum Categories
            const ALLOWED_CATEGORIES = ['HOTFIX', 'STAGE_INCIDENT', 'PRODUCTION_INCIDENT'];
            const MIN_REASON_LENGTH = 20;
            // ---------------------

            const prNumber = context.issue.number;
            const commentBody = context.payload.comment.body.trim();
            const actor = context.payload.comment.user.login;

            // --- 1. SUB-COMMAND CHECK ---
            // If the user typed "/release-orchestrator" but NOT the sub-command, ignore or hint?
            // For now, we strictly require the sub-command to proceed.
            if (!commentBody.startsWith(FULL_COMMAND)) {
               // Optional: If they just typed "/release-orchestrator help", allow it.
               if (commentBody !== `${ROOT_COMMAND} help`) {
                 return; // Ignore unrelated commands or typos
               }
            }

            // --- 2. HELP COMMAND ---
            // Triggers on:
            // "/release-orchestrator help"
            // "/release-orchestrator non-standard-change help"
            // "/release-orchestrator non-standard-change --help"
            if (commentBody.includes('help') || commentBody.includes('--help')) {
              const helpMessage = [
                `üìã **Non-Standard Engineering Change (NSEC) Helper**`,
                ``,
                `To execute a Non-Standard Engineering Change, use the following subcommand:`,
                `\`${FULL_COMMAND} --ticket=<ID> --category=<TYPE> --reason="<TEXT>"\``,
                ``,
                `**Required Fields:**`,
                `- \`--ticket\`: Jira ID (e.g., PROJ-123)`,
                `- \`--category\`: One of [${ALLOWED_CATEGORIES.map(c => `\`${c}\``).join(', ')}]`,
                `- \`--reason\`: Justification for this exception (min ${MIN_REASON_LENGTH} chars)`,
                ``,
                `**Example:**`,
                `\`${FULL_COMMAND} --ticket=OPS-123 --category=PRODUCTION_INCIDENT --reason="NSEC required for P0 outage recovery"\``
              ].join('\n');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body: helpMessage
              });
              return;
            }

            // --- 3. PARSE ARGUMENTS ---
            const args = {};
            const regex = /--([a-zA-Z0-9_-]+)=(?:"([^"]*)"|([^\s]*))/g;
            let match;
            
            // Remove the full command string so we only parse the flags
            const argsString = commentBody.replace(FULL_COMMAND, '');

            while ((match = regex.exec(argsString)) !== null) {
              const key = match[1].toLowerCase();
              const value = match[2] || match[3]; 
              args[key] = value;
            }

            // --- 4. VALIDATION HELPER ---
            async function rejectChange(errorMsg) {
              const body = `‚ùå **Change Request Rejected**: ${errorMsg}\n\nPlease review the protocols by typing \`${ROOT_COMMAND} help\`.`;
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body: body
              });
              core.setFailed(errorMsg);
            }

            // Basic Input Validation
            if (!args.ticket) return rejectChange("Missing required field: `--ticket`.");
            if (!args.category) return rejectChange("Missing required field: `--category`.");
            if (!args.reason) return rejectChange("Missing required field: `--reason`.");

            const inputTicket = args.ticket.toUpperCase();
            const inputCategory = args.category.toUpperCase();
            const inputReason = args.reason;
            
            if (!ALLOWED_CATEGORIES.includes(inputCategory)) {
              return rejectChange(`Invalid Category '${inputCategory}'. Allowed: ${ALLOWED_CATEGORIES.join(', ')}`);
            }
            if (inputReason.length < MIN_REASON_LENGTH) {
              return rejectChange(`Reason is too short. Please provide a detailed justification (min ${MIN_REASON_LENGTH} chars).`);
            }

            // ============================================================
            // üïµÔ∏è FAKE STEP 1: CHECK USER PERMISSIONS
            // ============================================================
            console.log(`üîê [AUTH] Verifying permissions for user: @${actor}...`);
            await new Promise(r => setTimeout(r, 1500)); 
            console.log(`‚úÖ [AUTH] User @${actor} is authorized for Non-Standard Changes.`);

            // ============================================================
            // üïµÔ∏è FAKE STEP 2: CHECK JIRA TICKET EXISTENCE
            // ============================================================
            console.log(`üîó [JIRA] Connecting to Jira API...`);
            console.log(`üîé [JIRA] Searching for ticket ID: ${inputTicket}...`);
            await new Promise(r => setTimeout(r, 1500));
            console.log(`‚úÖ [JIRA] Ticket ${inputTicket} found.`);
            console.log(`   - Status: IN_PROGRESS`);
            console.log(`   - Assignee: @${actor}`);

            // --- 5. EXECUTE CHANGE ---
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber
            });

            // ‚ö†Ô∏è Technical Audit Header remains "BYPASS MERGE"
            const commitBody = [
              `BYPASS MERGE`,
              `----------------`,
              `User: @${actor}`,
              `Ticket: ${inputTicket}`,
              `Category: ${inputCategory}`,
              `Reason: ${inputReason}`,
              `Date: ${new Date().toISOString()}`
            ].join('\n');

            try {
              console.log("üöÄ [EXEC] Initiating merge sequence...");
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: pr.title, 
                commit_message: commitBody 
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber,
                body: `‚úÖ **Non-Standard Engineering Change Accepted**\n\nChange ${inputTicket} has been committed to the repository.`
              });

            } catch (error) {
              await rejectChange(`Execution failed: ${error.message}`);
            }