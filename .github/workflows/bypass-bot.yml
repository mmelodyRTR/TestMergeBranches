name: "Structured ChatOps Bypass"

on:
  issue_comment:
    types: [created]

permissions:
  contents: read

jobs:
  bypass-merge:
    name: Validate & Execute
    runs-on: ubuntu-latest
    
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/bypass')

    steps:
      - name: Generate Bot Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.BYPASS_APP_ID }}
          private-key: ${{ secrets.BYPASS_APP_CLIENT_KEY }}

      - name: Process ChatOps
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            // --- CONFIGURATION ---
            const ALLOWED_CATEGORIES = ['HOTFIX', 'SECURITY', 'INFRA'];
            const MIN_REASON_LENGTH = 20;
            // ---------------------

            const prNumber = context.issue.number;
            const commentBody = context.payload.comment.body.trim();

            // --- 0. HELP COMMAND ---
            if (commentBody === '/bypass help' || commentBody === '/bypass --help') {
              const helpMessage = [
                `üëã **Bypass Bot Help**`,
                ``,
                `To bypass branch protections, use the following format:`,
                `\`/bypass --ticket=<ID> --category=<TYPE> --reason="<TEXT>"\``,
                ``,
                `**Required Flags:**`,
                `- \`--ticket\`: Jira ID (e.g., PROJ-123)`,
                `- \`--category\`: One of [${ALLOWED_CATEGORIES.join(', ')}]`,
                `- \`--reason\`: A description (min ${MIN_REASON_LENGTH} chars)`,
              ].join('\n');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body: helpMessage
              });
              return;
            }

            // --- 1. PARSE ARGUMENTS ---
            const args = {};
            const regex = /--([a-zA-Z0-9_-]+)=(?:"([^"]*)"|([^\s]*))/g;
            let match;

            while ((match = regex.exec(commentBody)) !== null) {
              const key = match[1].toLowerCase();
              const value = match[2] || match[3]; 
              args[key] = value;
            }

            // --- 2. VALIDATION HELPER ---
            async function failBypass(errorMsg) {
              const body = `‚ùå **Bypass Failed**: ${errorMsg}\n\nType \`/bypass help\` for usage instructions.`;
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body: body
              });
              core.setFailed(errorMsg);
            }

            // --- 3. VALIDATE INPUTS ---
            if (!args.ticket) return failBypass("Missing `--ticket` flag.");
            if (!args.category) return failBypass("Missing `--category` flag.");
            if (!args.reason) return failBypass("Missing `--reason` flag.");

            const inputTicket = args.ticket.toUpperCase();
            const inputCategory = args.category.toUpperCase();
            const inputReason = args.reason;
            
            if (!ALLOWED_CATEGORIES.includes(inputCategory)) {
              return failBypass(`Invalid Category '${inputCategory}'. Allowed: ${ALLOWED_CATEGORIES.join(', ')}`);
            }
            if (inputReason.length < MIN_REASON_LENGTH) {
              return failBypass(`Reason is too short. Must be at least ${MIN_REASON_LENGTH} characters.`);
            }

            // --- 4. EXECUTE MERGE ---
            
            // A. Fetch the Original PR Title
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber
            });

            // B. Construct the Commit Body (The Audit Log)
            // Note: We use "BYPASS MERGE" as the unique signature for your report tool to find later.
            const commitBody = [
              `BYPASS MERGE`,
              `----------------`,
              `User: @${context.actor}`,
              `Ticket: ${inputTicket}`,
              `Category: ${inputCategory}`,
              `Reason: ${inputReason}`,
              `Date: ${new Date().toISOString()}`
            ].join('\n');

            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                // C. USE ORIGINAL PR TITLE
                commit_title: pr.title, 
                // D. USE CONSTRUCTED BODY
                commit_message: commitBody 
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber,
                body: `‚úÖ **Bypassed!**\n\nMerged PR #${prNumber} for ticket ${inputTicket}.`
              });

            } catch (error) {
              await failBypass(`Merge failed: ${error.message}`);
            }