name: "App-Powered ChatOps Merge"

on:
  issue_comment:
    types: [created]

permissions:
  # We still need read access to see the workflow file itself
  contents: read

jobs:
  bypass-merge:
    name: App Bypass Merge
    runs-on: ubuntu-latest
    
    # 1. Trigger Check
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/bypass')

    steps:
      # --- NEW STEP: Authenticate as the App ---
      - name: Generate Bot Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.BYPASS_APP_ID }}
          private-key: ${{ secrets.BYPASS_APP_CLIENT_KEY }}

      # --- EXECUTE: Use the App Token ---
      - name: Execute Merge
        uses: actions/github-script@v7
        with:
          # IMPORTANT: We use the token generated in the previous step
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const prNumber = context.issue.number;
            const actor = context.actor;
            const org = context.repo.owner;
            const repo = context.repo.repo;
            const commentBody = context.payload.comment.body;

            console.log(`Processing bypass request from @${actor}`);

            // 1. Extract Reason
            const reason = commentBody.replace('/bypass', '').trim();
            if (!reason) console.log("Warning: No reason provided.");

            // 2. Prepare Audit Message
            const { data: pr } = await github.rest.pulls.get({
              owner: org, repo: repo, pull_number: prNumber
            });

            const commitMessage = [
              `BYPASS MERGE`,
              `----------------`,
              `Triggered by: @${actor}`,
              `Reason: ${reason || "None"}`,
              ``,
              `Original Title: ${pr.title}`
            ].join('\n');

            // 3. Execute Merge (Using App Token)
            try {
              await github.rest.pulls.merge({
                owner: org,
                repo: repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `Bypass Merge: PR #${prNumber}`,
                commit_message: commitMessage
              });

              // 4. Success Comment
              await github.rest.issues.createComment({
                owner: org, repo: repo, issue_number: prNumber,
                body: `✅ **Bypassed!**\n\nMerged by **${{ steps.app-token.outputs.app-slug }}** on behalf of @${actor}.`
              });

            } catch (error) {
              console.error(error);
              await github.rest.issues.createComment({
                owner: org, repo: repo, issue_number: prNumber,
                body: `⚠️ **Bypass Failed**: ${error.message}`
              });
              core.setFailed(`Merge execution failed: ${error.message}`);
            }
